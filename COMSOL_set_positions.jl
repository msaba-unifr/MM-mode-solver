using Distributed, BenchmarkTools, Plots, Plots.PlotMeasures, LinearAlgebra, DelimitedFiles, ColorSchemes, Dates, ProgressBars
rmprocs(2:1000)
addprocs(1)

@everywhere using Pkg
@everywhere Pkg.activate("./Code/MMSolver")

@everywhere using MMSolver

csol = [-3.1578472475812802e-15 - 8.55435514091063e-16im
-0.3046112670265279 - 0.0757183934461214im
-5.7409694768510754e-8 + 1.5721522234513237e-7im
-1.101440987028024e-15 - 2.8514517136368767e-16im
6.260591550843444e-5 + 1.671747829116272e-5im
0.41962218185737293 + 0.1042597740194603im
3.797960210216722e-14 + 1.0205378209171556e-14im
0.39964451514795285 + 0.09908444916036736im
-3.5529462115370565e-6 - 2.166000592226632e-6im
2.2766644034475e-15 + 5.160748761482444e-16im
-5.6137647307336145e-5 - 1.4864535990280329e-5im
-0.2134231820006331 - 0.05301838671913895im
-4.4711454048711186e-14 - 1.1969754614565842e-14im
-0.12012752331763935 - 0.02978939879303103im
-1.1851428036438263e-5 - 1.815420586362079e-6im
-4.886118026565904e-16 - 1.0283149386256657e-16im
-0.32081072144831746 - 0.07852574942154625im
-6.315350853208692e-6 - 7.909218065257212e-7im
3.5940709094831394e-16 + 7.812693092294765e-17im
4.705428705328082e-5 + 1.2991247609726517e-5im
0.2964454105549118 + 0.07156328313632794im
6.226932218553888e-15 + 1.5222198501696482e-15im
0.1599956243201503 + 0.03767650879891433im
-1.1368266098473433e-5 - 1.2435846523494408e-5im
-7.297383658173666e-16 - 1.1934016600455288e-16im
-1.2328817378058285e-5 - 3.755144007325413e-6im
-0.07556458169552689 - 0.017689772006845062im
-8.762379656492708e-15 - 2.1308909498030104e-15im
-0.019985167260312322 - 0.004357543940840932im
0.0001663527317962727 + 5.565816549263358e-5im
2.176829951103937e-14 + 5.92679117589201e-15im
-0.2612082986928232 - 0.06369154957859592im
-4.0264174375470585e-5 - 9.640124086912616e-6im
1.3863910020006642e-14 + 3.247402347028583e-15im
-0.0009289221743781217 - 0.00024637032422079874im
0.22629552485162563 + 0.05467586256081303im
-3.1622447715928814e-13 - 8.611514279444066e-14im
0.065710849463605 + 0.016008429552616416im
0.00037702957130422016 + 7.951947122425765e-5im
-2.8359259385268842e-14 - 6.612765890423589e-15im
0.000519935344062486 + 0.00013604270790147643im
-0.05599158334663504 - 0.013453321711733971im
3.834987882811447e-13 + 1.047213531168989e-13im
0.004320567261629896 + 0.0008263256075298313im
-0.00011868689989745322 - 5.05408569870117e-6im
9.020562075079397e-16 + 2.185751579730777e-16im
-0.213846259500464 - 0.05136277378908635im
2.526612680432e-5 + 6.082452351115902e-6im
-3.391384395534658e-16 - 5.0090140368830305e-17im
-6.639629274510228e-5 - 1.4554051372248425e-5im
0.15819421669040007 + 0.03779615723883817im
-1.2909812108219398e-14 - 3.2400297722556815e-15im
0.12616617161380705 + 0.030320469540319885im
-7.364613909606466e-5 - 1.880579261407181e-5im
5.622672466509826e-16 + 2.894819800536297e-17im
-0.00023418946208827313 - 7.317671930083362e-5im
-0.062273969868381844 - 0.014670690455651107im
1.8947408746139427e-14 + 4.930057013671774e-15im
-0.023919764834590792 - 0.005701803756219946im
-0.00039309280227973684 - 9.334854113370213e-5im
-2.1926904736346842e-14 - 6.022959908591474e-15im
-0.10284607162832729 - 0.024356605488513254im
5.509640612172406e-5 + 1.3280565299506053e-5im
-1.84297022087776e-14 - 4.3211961786582265e-15im
0.0011764472228322775 + 0.00031554598173613724im
0.040618394936951976 + 0.009392511637487187im
3.53036176681254e-13 + 9.620733029680473e-14im
0.041462833453568784 + 0.009105386947087152im
-0.0007003457816037104 - 0.00016482843074463755im
3.5867142589296463e-14 + 8.259885830863567e-15im
0.0005487994080597067 + 0.00013460990309072107im
-0.015231438119421018 - 0.0034158329752976054im
-3.406913423251168e-13 - 9.288866876198953e-14im
-0.007330291199473635 - 0.0016672051427382428im
0.00018648037967396256 + 5.03981198351378e-5im]
ksol = 0.0005606886180370765 + 0.2612128351596212im

freq = 400
λ = 2.99792458e5/freq      #wavelength in nm
φ = 90      #azimuthal angle of incidence, do not change in 1D for fixed y-z plane of incidence
θ = 0       #polar angle of incidence
ϵ_bg = 1 + 0im  #permittivity of background medium
mat_file = "Ag_JC_nk.txt"   #file storing permittivities of medium in sphere. Format as in refractiveindex.info files
a = 30.0    #lattice constant
A = [a/2 a; sqrt(3)*a/2 0]  #real space lattice matrix (see Lattice struct in parameters.jl)
Rad = 10.0  #radius of the d-sphere
NG = 1600

Nth = 201
Nr = 51
yz = zeros((2,Nr,Nth))
for (nr,r) in enumerate(range(0,stop=Rad-1e-5,length=Nr))
    for (nth,th) in enumerate(range(0,stop=2*pi,length=Nth))
        yz[1,nr,nth] = 3/4*a + r*cos(th)
        yz[2,nr,nth] = sqrt(3)/4*a + r*sin(th)
    end
end
writedlm("positions.txt",reshape(yz,(2,Nr*Nth))')
